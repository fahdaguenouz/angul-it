<h2>Captcha</h2>

<p>Stage {{ currentIndex + 1 }} / {{ stages.length }}</p>

<h3>{{ stage?.title }}</h3>
<p *ngIf="stage?.hint">{{ stage?.hint }}</p>

<!-- IMAGE SELECT -->
<div *ngIf="imageStage as s">
  <div class="grid">
    <button
      type="button"
      class="tile"
      *ngFor="let img of s.images"
      (click)="toggleImage(img.id)"
      [class.selected]="selected.has(img.id)"
      [attr.aria-pressed]="selected.has(img.id)"
    >
      <img [src]="img.url" [alt]="img.label" />
    </button>
  </div>
  <small>Select all that match the rule, then Next.</small>
</div>

<!-- MATH -->
<div *ngIf="mathStage as s">
  <label>
    {{ s.question }} =
    <input type="text" [formControl]="mathCtrl" />
  </label>
  <div class="field-error" *ngIf="mathCtrl.touched && mathCtrl.invalid">
    Answer is required.
  </div>
</div>

<!-- TEXT -->
<div *ngIf="textStage as s">
  <p><b>{{ s.prompt }}</b></p>
  <label>
    <input type="text" [formControl]="textCtrl" />
  </label>
  <div class="field-error" *ngIf="textCtrl.touched && textCtrl.invalid">
    Text is required.
  </div>
</div>

<p class="error" *ngIf="errorMsg">{{ errorMsg }}</p>

<div style="display:flex; gap:12px; margin-top: 12px;">
  <button (click)="prev()" [disabled]="currentIndex === 0">Prev</button>
  <button (click)="next()">Next</button>
</div>

<style>
  .grid{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:12px;
    max-width:520px;
    margin: 12px 0;
  }
  .tile{
    border:2px solid #ddd;
    border-radius:10px;
    padding:0;
    overflow:hidden;
    background:#fff;
    cursor:pointer;
  }
  .tile.selected{ border-color:#333; }
  .tile img{ width:100%; height:120px; object-fit:cover; display:block; }
  .error{ color:#b00020; margin-top: 8px; }
  .field-error{ color:#b00020; margin-top: 6px; }
</style>
